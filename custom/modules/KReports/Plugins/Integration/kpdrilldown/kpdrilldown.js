Ext.namespace('K.kreports.pdrilldown');Ext.define('K.kreports.pdrilldown.bg',{extend:'Ext.data.Model',fields:[{name:'id'},{name:'name'}]});K.kreports.pdrilldown.ad=new Ext.data.Store({model:K.kreports.pdrilldown.bg,pageSize:20,proxy:{type:'ajax',url:'index.php?module=KReports&action=pluginaction&plugin=kpdrilldown&pluginaction=getreports&to_pdf=true',reader:{type:'json'}}});K.kreports.pdrilldown.aN=new Ext.grid.Panel({store:K.kreports.pdrilldown.ad,columns:[{text:'name',dataIndex:'name',flex:1}],anchor:'100%',height:400,tbar:[{xtype:'textfield',id:'pdrilldownreportfilter',fieldLabel:'filter'},{xtype:'button',icon:'modules/KReports/images/selection.png',handler:function(){K.kreports.pdrilldown.ad.load({params:{filter:Ext.getCmp('pdrilldownreportfilter').getValue(),start:0,limit:K.kreports.pdrilldown.ad.pageSize}});}}],dockedItems:[{xtype:'pagingtoolbar',store:K.kreports.pdrilldown.ad,dock:'bottom',displayInfo:true}]});K.kreports.pdrilldown.aH=new Ext.Window({title:bi('LBL_ADDLINKEDREPORT_TITLE'),layout:{type:'anchor',align:'middle'},width:400,modal:true,autoHeight:true,closeAction:'hide',plain:true,border:false,resizable:false,items:[K.kreports.pdrilldown.aN],buttons:[{text:bi('LBL_CANCEL'),handler:function(){K.kreports.pdrilldown.aH.hide();}},{text:bi('LBL_ADDLINK_ADD'),handler:function(){if(K.kreports.pdrilldown.aN.getSelectionModel().getCount()>0){var selArray=K.kreports.pdrilldown.aN.getSelectionModel().getSelection();K.kreports.pdrilldown.store.add({linkid:kGuid(),reportid:selArray[0].get('id'),reportname:selArray[0].get('name'),linktype:'LINK'});}K.kreports.pdrilldown.aH.hide();}}]});Ext.define('K.kreports.pdrilldown.aG',{extend:'Ext.data.Model',fields:[{name:'whereid',mapping:'whereid'},{name:'wherename',mapping:'wherename'},{name:'mappedid',mapping:'mappedid'}]});K.kreports.pdrilldown.az=new Ext.data.Store({model:K.kreports.pdrilldown.aG,proxy:{type:'memory',reader:{type:'json'}}});K.kreports.pdrilldown.bG=new Ext.grid.Panel({store:K.kreports.pdrilldown.az,plugins:[Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1})],viewConfig:{markDirty:false},columns:[{text:'wherename',dataIndex:'wherename',flex:1},{text:'mappedid',dataIndex:'mappedid',flex:1,editor:{xtype:'combobox',typeAhead:true,editable:false,triggerAction:'all',lazyRender:true,queryMode:'local',store:listGridStore,valueField:'fieldid',displayField:'name'},renderer:function(t){if(t){var foundRecord=listGridStore.findRecord('fieldid',t);if(foundRecord)return foundRecord.get('name');else return t;}else return t;}}],anchor:'100%',height:400});K.kreports.pdrilldown.ak=new Ext.LoadMask(K.kreports.pdrilldown.bG,{msg:'loading'});K.kreports.pdrilldown.bJ=new Ext.Window({title:bi('LBL_MAPPING_TITLE'),an:null,layout:{type:'anchor',align:'middle'},width:400,modal:true,autoHeight:true,closeAction:'hide',plain:true,border:false,resizable:false,items:[K.kreports.pdrilldown.bG],buttons:[{text:bi('LBL_CANCEL'),handler:function(){K.kreports.pdrilldown.bJ.hide();}},{text:bi('LBL_SAVE'),handler:function(){var ai=new Array();for(var i=0;i<K.kreports.pdrilldown.az.data.items.length;i++){ai.push(K.kreports.pdrilldown.az.data.items[i].data);}K.kreports.pdrilldown.bJ.an.set('mappingdata',ai);K.kreports.pdrilldown.bJ.hide();}}],listeners:{show:function(){K.kreports.pdrilldown.ak.show();Ext.Ajax.request({url:'index.php?module=KReports&action=pluginaction&plugin=kpdrilldown&pluginaction=getwherefields&to_pdf=true&wherereportid='+K.kreports.pdrilldown.bJ.an.get('reportid'),success:function(response){var newCols=Ext.JSON.decode(response.responseText);var mappingdata=K.kreports.pdrilldown.bJ.an.get('mappingdata');for(var i=0;i<newCols.length;i++){var aV='';if(mappingdata&&mappingdata.length>0){for(var j=0;j<mappingdata.length;j++){if(mappingdata[j].whereid==newCols[i].fieldid){aV=mappingdata[j].mappedid;break;}}}K.kreports.pdrilldown.az.add({whereid:newCols[i].fieldid,wherename:newCols[i].name,mappedid:aV})}K.kreports.pdrilldown.ak.hide();}});}}});Ext.define('K.kreports.pdrilldown.model',{extend:'Ext.data.Model',fields:[{name:'linkid',mapping:'linkid'},{name:'displayname',mapping:'displayname'},{name:'reportid',mapping:'reportid'},{name:'reportname',mapping:'reportname'},{name:'linktype',mapping:'linktype'},{name:'mappingdata',mapping:'mappingdata'}]});K.kreports.pdrilldown.store=new Ext.data.Store({model:K.kreports.pdrilldown.model,proxy:{type:'memory',reader:{type:'json'}}});K.kreports.pdrilldown.thePanel=new Ext.grid.Panel({layout:{type:'anchor',defaultAnchor:'90%'},height:'100%',pluginid:'kpdrilldown',viewConfig:{markDirty:false,plugins:{ptype:'gridviewdragdrop'}},plugins:[Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1})],store:K.kreports.pdrilldown.store,columns:[{text:'name',dataIndex:'reportname',width:180},{text:'displayname',dataIndex:'displayname',width:180,editor:new Ext.form.TextField()},{text:'linktype',dataIndex:'linktype',renderer:function(value){if(value!='')return bi('LBL_'+value+'_LINKTYPE');else return value;},editor:new Ext.form.field.ComboBox({typeAhead:false,editable:false,triggerAction:'all',forceSelection:true,width:100,lazyRender:true,value:'LINK',mode:'local',store:new Ext.data.ArrayStore({id:0,fields:['value','text'],data:[['LINK',bi('LBL_LINK_LINKTYPE')],['POPUP',bi('LBL_POPUP_LINKTYPE')],['CHART',bi('LBL_CHART_LINKTYPE')]]}),valueField:'value',displayField:'text'}),width:80}],tbar:[{xtype:'button',text:'add',icon:'modules/KReports/images/add.png',handler:function(){K.kreports.pdrilldown.ad.load({params:{start:0,limit:K.kreports.pdrilldown.ad.pageSize}});K.kreports.pdrilldown.aH.show();}},{xtype:'button',text:'delete',icon:'modules/KReports/images/delete.png',handler:function(){K.kreports.pdrilldown.store.remove(K.kreports.pdrilldown.thePanel.getSelectionModel().getSelection());}},{xtype:'button',text:'mapping',icon:'modules/KReports/images/mapping.png',handler:function(){if(K.kreports.pdrilldown.thePanel.getSelectionModel().getCount()>0){K.kreports.pdrilldown.az.removeAll();K.kreports.pdrilldown.bJ.an=K.kreports.pdrilldown.thePanel.getSelectionModel().getSelection()[0];K.kreports.pdrilldown.bJ.show();}}}],setPanelData:function(pluginParams){K.kreports.pdrilldown.store.removeAll();for(var i=0;i<pluginParams.length;i++)K.kreports.pdrilldown.store.add(pluginParams[i]);},getPanelData:function(){var schedulerArray=new Array();for(var i=0;i<K.kreports.pdrilldown.store.count();i++)schedulerArray.push(K.kreports.pdrilldown.store.data.items[i].data);return schedulerArray;}})
Ext.namespace('K.kreports.pivotpanel');Ext.define('K.kreports.pivotpanel.fieldModel',{extend:'Ext.data.Model',fields:[{name:'fieldid',type:'string'},{name:'name',type:'string'}]});K.kreports.pivotpanel.repositoryStore=new Ext.data.Store({model:K.kreports.pivotpanel.fieldModel,addRecordFromFieldStore:function(record){K.kreports.pivotpanel.repositoryStore.add({name:record.get('name'),fieldid:record.get('fieldid')})}});K.kreports.pivotpanel.repositoryGrid=new Ext.grid.Panel({store:listGridStore,frame:true,height:300,columnLines:true,title:bi('LBL_PIVOT_REPOSITORY'),border:0,plugins:[Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1})],columns:[{text:bi('LBL_PATH'),readOnly:true,dataIndex:'displaypath',width:150,sortable:false},{text:bi('LBL_NAME'),dataIndex:'name',sortable:false,width:150},{text:bi('LBL_SQLFUNCTION'),readOnly:true,dataIndex:'sqlfunction',width:90,sortable:false,hidden:false,renderer:function(value){if(value!=undefined&&value!='-')return bi('LBL_FUNCTION_'+value.toUpperCase());else return value;}},{text:bi('LBL_SORTSEQUENCE'),readOnly:true,dataIndex:'sort',width:50,sortable:false,hidden:false,editor:new Ext.form.ComboBox({typeAhead:true,triggerAction:'all',lazyRender:true,mode:'local',store:new Ext.data.ArrayStore({id:0,fields:['value','text'],data:[['-','-'],['asc',bi('LBL_SORT_ASC')],['desc',bi('LBL_SORT_DESC')],['sortable',bi('LBL_SORT_SORTABLE')]]}),valueField:'value',displayField:'text'}),renderer:function(value){if(value!=undefined&&value!='-')return bi('LBL_SORT_'+value.toUpperCase());else return value;}},{text:bi('LBL_SORTPRIORITY'),dataIndex:'sortpriority',sortable:false,width:50,editor:new Ext.form.NumberField()},{header:bi('LBL_OVERRIDETYPE'),width:160,dataIndex:'overridetype',editor:new Ext.form.field.ComboBox({typeAhead:true,triggerAction:'all',lazyRender:true,edtiable:false,store:new Ext.data.ArrayStore({fields:['value','text'],data:[['','-'],['none',bi('LBL_RENDERER_NONE')],['currency',bi('LBL_RENDERER_CURRENCY')],['percentage',bi('LBL_RENDERER_PERCENTAGE')],['number',bi('LBL_RENDERER_NUMBER')],['int',bi('LBL_RENDERER_INT')],['float',bi('LBL_RENDERER_FLOAT')],['date',bi('LBL_RENDERER_DATE')],['datetime',bi('LBL_RENDERER_DATETIME')],['bool',bi('LBL_RENDERER_BOOL')],['text',bi('LBL_RENDERER_TEXT')]]}),valueField:'value',displayField:'text'}),renderer:function(value){if(value!=undefined&&value!='')return bi('LBL_RENDERER_'+value.toUpperCase());else return value;}}],viewConfig:{stripeRows:true,forcefit:true,plugins:{dragGroup:'repositoryFields',ptype:'gridviewdragdrop',enableDrop:false}}});K.kreports.pivotpanel.addRowStore=new Ext.data.Store({model:K.kreports.pivotpanel.fieldModel});K.kreports.pivotpanel.addRowGrid=new Ext.grid.Panel({store:K.kreports.pivotpanel.addRowStore,height:235,frame:true,columnLines:true,title:bi('LBL_PIVOT_ADDROWINFO'),border:0,collapsible:true,collapsed:true,columns:[{text:bi('LBL_NAME'),dataIndex:'name',sortable:false,width:150}],tbar:[{xtype:'button',text:bi('LBL_DELETE_BUTTON_LABEL'),icon:'modules/KReports/images/delete.png',handler:function(){K.kreports.pivotpanel.addRowStore.remove(K.kreports.pivotpanel.addRowGrid.getSelectionModel().getSelection());}}],viewConfig:{markDirty:false,plugins:{dropGroup:'repositoryFields',dragGroup:'repositoryFields',ptype:'gridviewdragdrop',enableDrop:true},listeners:{beforedrop:function(node,data,overModel,dropPosition,dropFunctions,eOpts){if(data.records[0].$className=='K.kreports.pivotpanel.valueModel')return false;if(data.records[0].$className=='K.kreports.mainListGrid.listedFieldsModel'){for(var recordCounter=0;recordCounter<data.records.length;recordCounter++){var storeIndex=this.getStore().indexOf(overModel);if(dropPosition=='after')storeIndex++;if(storeIndex==this.getStore().count())this.getStore().add({fieldid:data.records[recordCounter].get('fieldid'),name:data.records[recordCounter].data.name});else this.getStore().insert(storeIndex,{fieldid:data.records[recordCounter].get('fieldid'),name:data.records[recordCounter].data.name});}dropFunctions.cancelDrop();return true;}return true;}}}});K.kreports.pivotpanel.columnStore=new Ext.data.Store({model:K.kreports.pivotpanel.fieldModel});K.kreports.pivotpanel.columnGrid=new Ext.grid.Panel({store:K.kreports.pivotpanel.columnStore,height:150,collapsible:true,frame:true,columnLines:true,title:bi('LBL_PIVOT_COLUMNS'),border:0,columns:[{text:bi('LBL_NAME'),dataIndex:'name',sortable:false,width:150}],tbar:[{xtype:'button',text:bi('LBL_DELETE_BUTTON_LABEL'),icon:'modules/KReports/images/delete.png',handler:function(){K.kreports.pivotpanel.columnStore.remove(K.kreports.pivotpanel.columnGrid.getSelectionModel().getSelection());}}],viewConfig:{markDirty:false,plugins:{dropGroup:'repositoryFields',dragGroup:'repositoryFields',ptype:'gridviewdragdrop',enableDrop:true},listeners:{beforedrop:function(node,data,overModel,dropPosition,dropFunctions,eOpts){if(data.records[0].$className=='K.kreports.pivotpanel.valueModel')return false;if(data.records[0].$className=='K.kreports.mainListGrid.listedFieldsModel'){for(var recordCounter=0;recordCounter<data.records.length;recordCounter++){var storeIndex=this.getStore().indexOf(overModel);if(dropPosition=='after')storeIndex++;if(storeIndex==this.getStore().count())this.getStore().add({fieldid:data.records[recordCounter].get('fieldid'),name:data.records[recordCounter].data.name});else this.getStore().insert(storeIndex,{fieldid:data.records[recordCounter].get('fieldid'),name:data.records[recordCounter].data.name});}dropFunctions.cancelDrop();return true;}return true;}}}});K.kreports.pivotpanel.rowStore=new Ext.data.Store({model:K.kreports.pivotpanel.fieldModel});K.kreports.pivotpanel.rowCombo=new Ext.form.field.ComboBox({fieldLabel:bi('LBL_PIVOT_ROWS'),height:20,store:listGridStore,queryMode:'local',editable:false,displayField:'name',valueField:'fieldid'});Ext.define('K.kreports.pivotpanel.valueModel',{extend:'Ext.data.Model',fields:[{name:'fieldid',type:'string'},{name:'name',type:'string'},{name:'pivotfunction',type:'string'},{name:'pivotrenderer',type:'string'}]});K.kreports.pivotpanel.valueStore=new Ext.data.Store({model:K.kreports.pivotpanel.valueModel});K.kreports.pivotpanel.valueGrid=new Ext.grid.Panel({store:K.kreports.pivotpanel.valueStore,height:150,collapsible:true,frame:true,columnLines:true,title:bi('LBL_PIVOT_VALUES'),border:0,plugins:[Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1})],columns:[{text:bi('LBL_NAME'),dataIndex:'name',sortable:false,width:150},{text:bi('LBL_FUNCTION'),dataIndex:'pivotfunction',sortable:false,width:150,editor:new Ext.form.ComboBox({typeAhead:true,triggerAction:'all',lazyRender:true,mode:'local',store:new Ext.data.ArrayStore({id:0,fields:['value','text'],data:[['-','-'],['SUM',bi('LBL_FUNCTION_SUM')],['COUNT',bi('LBL_FUNCTION_COUNT')],['MAX',bi('LBL_FUNCTION_MAX')],['MIN',bi('LBL_FUNCTION_MIN')]]}),valueField:'value',displayField:'text'}),renderer:function(value){if(value!=undefined&&value!='-')return bi('LBL_FUNCTION_'+value.toUpperCase());else return value;}},{text:bi('LBL_RENDERER'),dataIndex:'pivotrenderer',sortable:false,width:150,editor:new Ext.form.ComboBox({typeAhead:true,triggerAction:'all',lazyRender:true,mode:'local',store:new Ext.data.ArrayStore({id:0,fields:['value','text'],data:[['','-'],['none',bi('LBL_RENDERER_NONE')],['currency',bi('LBL_RENDERER_CURRENCY')],['percentage',bi('LBL_RENDERER_PERCENTAGE')],['number',bi('LBL_RENDERER_NUMBER')],['int',bi('LBL_RENDERER_INT')],['float',bi('LBL_RENDERER_FLOAT')],['date',bi('LBL_RENDERER_DATE')],['datetime',bi('LBL_RENDERER_DATETIME')],['bool',bi('LBL_RENDERER_BOOL')],['text',bi('LBL_RENDERER_TEXT')]]}),valueField:'value',displayField:'text'}),renderer:function(value){if(value!=undefined&&value!='-'&&value!='')return bi('LBL_RENDERER_'+value.toUpperCase());else return value;}}],tbar:[{xtype:'button',text:bi('LBL_DELETE_BUTTON_LABEL'),icon:'modules/KReports/images/delete.png',handler:function(){K.kreports.pivotpanel.valueStore.remove(K.kreports.pivotpanel.valueGrid.getSelectionModel().getSelection());}}],viewConfig:{markDirty:false,plugins:{dropGroup:'repositoryFields',dragGroup:'repositoryFields',ptype:'gridviewdragdrop',enableDrop:true},listeners:{beforedrop:function(node,data,overModel,dropPosition,dropFunctions,eOpts){if(this.getStore().count()>0){Ext.MessageBox.alert('Error','Only one value can be added at this time');dropFunctions.cancelDrop();return true;}if(data.records[0].$className=='K.kreports.pivotpanel.fieldModel')return false;if(data.records[0].$className=='K.kreports.mainListGrid.listedFieldsModel'){for(var recordCounter=0;recordCounter<data.records.length;recordCounter++){var storeIndex=this.getStore().indexOf(overModel);if(dropPosition=='after')storeIndex++;if(storeIndex==this.getStore().count())this.getStore().add({fieldid:data.records[recordCounter].get('fieldid'),name:data.records[recordCounter].data.name,pivotfunction:'SUM'});else this.getStore().insert(storeIndex,{fieldid:data.records[recordCounter].get('fieldid'),name:data.records[recordCounter].data.name,pivotfunction:'SUM'});}dropFunctions.cancelDrop();return true;}return true;}}}});K.kreports.pivotpanel.panel=new Ext.Panel({frame:false,bodyPadding:5,border:false,items:[{xtype:'fieldset',collapsible:false,title:bi('LBL_PIVOT_SETTINGS'),bodyPadding:5,layout:'column',border:true,items:[{xtype:'panel',width:'100%',border:false,layout:'column',items:[{columnWidth:0.5,border:false,bodyPadding:5,layout:'anchor',defaults:{anchor:'100%'},items:[K.kreports.pivotpanel.repositoryGrid]},{columnWidth:0.5,border:false,bodyPadding:5,layout:'anchor',defaults:{anchor:'100%'},items:[K.kreports.pivotpanel.rowCombo,K.kreports.pivotpanel.addRowGrid,K.kreports.pivotpanel.columnGrid,K.kreports.pivotpanel.valueGrid]}]}]},{xtype:'fieldset',collapsible:false,title:bi('LBL_PIVOT_ADVANCED'),bodyPadding:5,items:[{xtype:'form',border:false,layout:'column',items:[{columnWidth:0.5,border:false,bodyPadding:5,layout:'anchor',defaults:{anchor:'100%'},items:[{xtype:'numberfield',fieldLabel:bi('LBL_PIVOT_NAMECOLUMNWIDTH'),labelWidth:200,id:'K.kreports.pivotpanel.namecolumnwidth'},{xtype:'numberfield',fieldLabel:bi('LBL_PIVOT_MINCOLUMNWIDTH'),labelWidth:200,id:'K.kreports.pivotpanel.mincolumnwidth'}]},{columnWidth:0.25,border:false,bodyPadding:5,layout:'anchor',defaults:{anchor:'100%'},items:[{xtype:'checkbox',boxLabel:bi('LBL_PIVOT_EMPTYCOLUMNS'),id:'K.kreports.pivotpanel.pivotempty'},{xtype:'checkbox',boxLabel:bi('LBL_PIVOT_TOTALS'),id:'K.kreports.pivotpanel.pivottotals'},{xtype:'checkbox',boxLabel:bi('LBL_PIVOT_SUMS'),id:'K.kreports.pivotpanel.pivotsums'}]},{columnWidth:0.25,border:false,bodyPadding:5,layout:'anchor',defaults:{anchor:'100%'},items:[{xtype:'checkbox',boxLabel:bi('LBL_PIVOT_ADJUSTCOLUMNS'),id:'K.kreports.pivotpanel.pivotadjust'},{xtype:'checkbox',boxLabel:bi('LBL_PIVOT_SORTCOLUMNS'),id:'K.kreports.pivotpanel.pivotsort'},{xtype:'checkbox',boxLabel:bi('LBL_PIVOT_ROTATEHEADERS'),id:'K.kreports.pivotpanel.pivotrotateheaders'}]}]}]}],updateHandler:function(){},initialize:function(panelData){if(panelData.rowData!=undefined)K.kreports.pivotpanel.rowCombo.setValue(panelData.rowData);if(panelData.columnData!=undefined){K.kreports.pivotpanel.columnStore.removeAll();for(var i=0;i<panelData.columnData.length;i++)K.kreports.pivotpanel.columnStore.add(panelData.columnData[i]);}if(panelData.valueData!=undefined){K.kreports.pivotpanel.valueStore.removeAll();for(i=0;i<panelData.valueData.length;i++)K.kreports.pivotpanel.valueStore.add(panelData.valueData[i]);}if(panelData.addRowData!=undefined){K.kreports.pivotpanel.addRowStore.removeAll();for(i=0;i<panelData.addRowData.length;i++)K.kreports.pivotpanel.addRowStore.add(panelData.addRowData[i]);}if(panelData.advancedOptions!=undefined){Ext.getCmp('K.kreports.pivotpanel.pivottotals').setValue(panelData.advancedOptions.showTotal);Ext.getCmp('K.kreports.pivotpanel.pivotsums').setValue(panelData.advancedOptions.showSum);Ext.getCmp('K.kreports.pivotpanel.pivotempty').setValue(panelData.advancedOptions.showEmpty);Ext.getCmp('K.kreports.pivotpanel.pivotadjust').setValue(panelData.advancedOptions.adjustwidth);Ext.getCmp('K.kreports.pivotpanel.pivotsort').setValue(panelData.advancedOptions.sortValues);Ext.getCmp('K.kreports.pivotpanel.pivotrotateheaders').setValue(panelData.advancedOptions.rotateHeaders);Ext.getCmp('K.kreports.pivotpanel.namecolumnwidth').setValue(panelData.advancedOptions.nameWidth);Ext.getCmp('K.kreports.pivotpanel.mincolumnwidth').setValue(panelData.advancedOptions.minWidth);}},getPanelData:function(){panelData={rowData:K.kreports.pivotpanel.rowCombo.getValue(),columnData:new Array(),valueData:new Array(),addRowData:new Array(),advancedOptions:{}};for(var i=0;i<K.kreports.pivotpanel.columnStore.count();i++)panelData.columnData.push(K.kreports.pivotpanel.columnStore.data.items[i].data);for(i=0;i<K.kreports.pivotpanel.valueStore.count();i++)panelData.valueData.push(K.kreports.pivotpanel.valueStore.data.items[i].data);for(i=0;i<K.kreports.pivotpanel.addRowStore.count();i++)panelData.addRowData.push(K.kreports.pivotpanel.addRowStore.data.items[i].data);panelData.advancedOptions.showTotal=Ext.getCmp('K.kreports.pivotpanel.pivottotals').getValue();panelData.advancedOptions.showSum=Ext.getCmp('K.kreports.pivotpanel.pivotsums').getValue();panelData.advancedOptions.showEmpty=Ext.getCmp('K.kreports.pivotpanel.pivotempty').getValue();panelData.advancedOptions.adjustwidth=Ext.getCmp('K.kreports.pivotpanel.pivotadjust').getValue();panelData.advancedOptions.sortValues=Ext.getCmp('K.kreports.pivotpanel.pivotsort').getValue();panelData.advancedOptions.nameWidth=Ext.getCmp('K.kreports.pivotpanel.namecolumnwidth').getValue();panelData.advancedOptions.minWidth=Ext.getCmp('K.kreports.pivotpanel.mincolumnwidth').getValue();panelData.advancedOptions.rotateHeaders=Ext.getCmp('K.kreports.pivotpanel.pivotrotateheaders').getValue();return panelData;}}); 